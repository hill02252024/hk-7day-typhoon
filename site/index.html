<script>
  async function fetchJSON(candidates){
    for (const url of candidates){
      try{
        const r = await fetch(url, {cache:"no-store"});
        if (r.ok) return await r.json();
      }catch(e){}
    }
    throw new Error("All candidates failed: " + candidates.join(", "));
  }

  async function loadAll(){
    const paths = (name) => [
      `data/processed/${name}.json`,
      `/hk-7day-typhoon/data/processed/${name}.json`
    ];
    const [cons, risk, impact, lb] = await Promise.all([
      fetchJSON(paths("consensus_0_5d")),
      fetchJSON(paths("risk_6_7d")).catch(()=>({days:[]})),
      fetchJSON(paths("hk_impact")).catch(()=>null),
      fetchJSON(paths("leaderboard")).catch(()=>null),
    ]);
    return {cons, risk, impact, lb};
  }

  function renderConsensus(cons, mode){
    const tb = document.querySelector("#tbl tbody");
    const days = (cons?.days || []);
    let show = days;
    if (mode==="0_5") show = days;
    if (mode==="6_7") show = []; // 6–7天用 risk 檔顯示
    if (mode==="all") show = days;

    tb.innerHTML = show.map(d => `
      <tr>
        <td>${d.date||"-"}</td>
        <td>${d.text||"-"}</td>
        <td class="hide-sm">${(d.tmin??"-")}°C</td>
        <td class="hide-sm">${(d.tmax??"-")}°C</td>
      </tr>
    `).join("");
    const srcs = cons?.meta?.sources_used || [];
    document.getElementById("status").textContent =
      `已載入 ${days.length} 天；共用來源：${srcs.length}（${srcs.join(", ")})`;
  }

  function renderRisk(risk, mode){
    if (mode!=="6_7") return;
    const tb = document.querySelector("#tbl tbody");
    const days = risk?.days || [];
    tb.innerHTML = days.map(d => `
      <tr>
        <td>${d.date||"-"}</td>
        <td>延伸預報（信賴度：${d.confidence}；來源數：${d.source_count}）</td>
        <td class="hide-sm">—</td>
        <td class="hide-sm">—</td>
      </tr>
    `).join("");
  }

  function renderImpact(impact){
    const el = document.getElementById("impact");
    if (!impact) { el.textContent = "尚未生成 impact"; return; }
    document.getElementById("updated").textContent = impact.as_of_utc || impact.as_of || "—";
    el.innerHTML = `<span class="badge">as of: ${impact.as_of_utc||impact.as_of}</span>
                    <span class="badge">risk: ${impact.risk||"—"}</span>`;
  }

  function renderLeaderboard(lb){
    if (!lb) return;
    document.getElementById("best").textContent = lb.overall_best || "—";
  }

  async function boot(){
    const range = document.getElementById("range").value;
    const {cons, risk, impact, lb} = await loadAll();
    if (range==="6_7") renderRisk(risk, range); else renderConsensus(cons, range);
    renderImpact(impact);
    renderLeaderboard(lb);
  }

  document.getElementById("range").addEventListener("change", boot);
  document.getElementById("refresh").addEventListener("click", boot);
  boot();
</script>
